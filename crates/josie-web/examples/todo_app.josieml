<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Josie Lisp Todo</title>
</head>
<body class="min-h-screen bg-zinc-950 text-zinc-100 antialiased">
  <main class="mx-auto max-w-3xl px-4 py-10">
    <section class="rounded-2xl border border-zinc-800 bg-zinc-900/80 p-6 shadow-2xl shadow-black/30">
      <header class="mb-6 space-y-1">
        <h1 class="text-2xl font-semibold tracking-tight" j-text="client.appTitle"></h1>
        <p class="text-sm text-zinc-400">Pure Josie Lisp syntax. Zero-cost compilation.</p>
      </header>

      <form class="mb-4 flex gap-2" @submit="todo.add">
        <input
          type="text"
          j-model="client.newTodo"
          placeholder="Add a task..."
          class="flex-1 rounded-xl border border-zinc-700 bg-zinc-950 px-3 py-2 text-sm outline-none ring-0 placeholder:text-zinc-500 focus:border-cyan-500"
        />
        <button
          type="submit"
          class="rounded-xl bg-cyan-500 px-4 py-2 text-sm font-medium text-zinc-950 hover:bg-cyan-400"
        >Add</button>
      </form>

      <div class="mb-4 grid grid-cols-3 gap-2 text-xs">
        <div class="rounded-lg border border-zinc-700 bg-zinc-800/60 px-3 py-2">
          <div class="text-zinc-400">Total</div>
          <div class="mt-1 text-lg font-semibold" j-text="client.stats.total"></div>
        </div>
        <div class="rounded-lg border border-zinc-700 bg-zinc-800/60 px-3 py-2">
          <div class="text-zinc-400">Done</div>
          <div class="mt-1 text-lg font-semibold text-emerald-400" j-text="client.stats.done"></div>
        </div>
        <div class="rounded-lg border border-zinc-700 bg-zinc-800/60 px-3 py-2">
          <div class="text-zinc-400">Open</div>
          <div class="mt-1 text-lg font-semibold text-amber-300" j-text="client.stats.open"></div>
        </div>
      </div>

      <!-- data-josie-map still uses JSON for its configuration object -->
      <ul class="space-y-2" data-josie-map='{"source":"client.viewTodos"}'>
        <li j-attr:class="local.item.rowClass">
          <button
            type="button"
            j-attr:value="local.item.id"
            @click="todo.toggle"
            class="rounded-md border border-cyan-500/40 bg-cyan-500/10 px-2 py-1 text-[10px] font-semibold tracking-wide text-cyan-200 hover:border-cyan-400 hover:bg-cyan-500/20 hover:text-cyan-100"
            j-text="local.item.status"
          ></button>

          <p class="flex-1 text-sm" j-attr:class="local.item.titleClass" j-text="local.item.title"></p>

          <button
            type="button"
            j-attr:value="local.item.id"
            @click="todo.delete"
            class="rounded-md border border-red-500/50 bg-red-500/10 px-2 py-1 text-xs text-red-200 hover:bg-red-500/20"
          >Delete</button>
        </li>
      </ul>

      <footer class="mt-4 flex items-center justify-between">
        <p class="text-xs text-zinc-500">Click status badge to toggle done/open.</p>
        <button
          type="button"
          @click="todo.clear_done"
          class="rounded-lg border border-amber-500/40 bg-amber-500/10 px-3 py-1.5 text-xs text-amber-200 hover:bg-amber-500/20 hover:text-amber-100"
        >Clear Completed</button>
      </footer>
    </section>
  </main>

  <script type="josie/script">
    # Initial State
    (set client.appTitle "Josie Lisp Todo")
    (set client.newTodo "")
    (set client.seq 4)
    (set client.todos [
      { id: "1", title: "Define pipeline contract", done: false }
      { id: "2", title: "Build webhook flow", done: true }
      { id: "3", title: "Ship project dashboard", done: false }
    ])

    # Recalculate Statistics
    (def todo.recalc ()
      (do
        (set client.stats.total (len client.todos))
        (set client.stats.done 
          (reduce client.todos (if item.done (+ acc 1) acc) 0))
        (set client.stats.open (- client.stats.total client.stats.done))))

    # Synchronize View Model (Tailwind classes)
    (def todo.sync_view ()
      (set client.viewTodos
        (map client.todos {
          id: item.id
          title: item.title
          done: item.done
          status: (if item.done "DONE" "OPEN")
          rowClass: (if item.done 
            "flex items-center gap-3 rounded-xl border border-emerald-500/30 bg-emerald-500/10 px-3 py-2"
            "flex items-center gap-3 rounded-xl border border-zinc-700 bg-zinc-800/60 px-3 py-2")
          titleClass: (if item.done
            "flex-1 text-sm text-zinc-400 line-through"
            "flex-1 text-sm text-zinc-100")
        })))

    # Actions
    (def todo.add ()
      (do
        (w.event.prevent)
        (if (> (util.str_len (util.trim client.newTodo)) 0)
          (do
            (set client.todos (push client.todos {
              id: (util.to_string client.seq)
              title: (util.trim client.newTodo)
              done: false
            }))
            (set client.seq (+ client.seq 1))
            (set client.newTodo "")
            (todo.recalc)
            (todo.sync_view)))))

    (def todo.toggle ()
      (do
        (set client.todos (map client.todos {
          id: item.id
          title: item.title
          done: (if (== item.id w.event.value) (! item.done) item.done)
        }))
        (todo.recalc)
        (todo.sync_view)))

    (def todo.delete ()
      (do
        (set client.todos (filter client.todos (!= item.id w.event.value)))
        (todo.recalc)
        (todo.sync_view)))

    (def todo.clear_done ()
      (do
        (set client.todos (filter client.todos (! item.done)))
        (todo.recalc)
        (todo.sync_view)))

    # Boot
    (todo.recalc)
    (todo.sync_view)
  </script>
</body>
</html>
